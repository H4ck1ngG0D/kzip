<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>音割れツール</title>
  <style>
    body { background: #111; color: #fff; font-family: monospace; text-align: center; padding: 20px; }
    input { margin: 10px; }
    #log {
      background: #000;
      color: #0f0;
      font-size: 14px;
      padding: 10px;
      margin-top: 20px;
      height: 150px;
      overflow-y: auto;
      border: 1px solid #444;
    }
  </style>
</head>
<body>
  <h1>音割れツール（WAV/MP3対応）</h1>
  <input type="file" id="audioFile" accept=".wav, .mp3">
  <button onclick="processAudio()">音割れさせる</button>
  <div id="log">ログ:</div>
  <script>
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let sourceNode;

    function log(msg) {
      const logDiv = document.getElementById("log");
      logDiv.innerText += "\n" + msg;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function processAudio() {
      const fileInput = document.getElementById("audioFile");
      if (!fileInput.files.length) {
        log("ファイルが選択されていません");
        return;
      }

      const file = fileInput.files[0];
      log(`読み込み中: ${file.name}`);
      const arrayBuffer = await file.arrayBuffer();

      try {
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
        const bufferSource = audioCtx.createBufferSource();
        bufferSource.buffer = audioBuffer;

        // 音割れさせるために過剰にゲインを上げる
        const gainNode = audioCtx.createGain();
        gainNode.gain.value = 10.0;  // 通常の音量の10倍

        // エフェクト（クリッピング）を追加
        const waveShaper = audioCtx.createWaveShaper();
        waveShaper.curve = new Float32Array([ -1, -0.8, 0, 0.8, 1 ]); // 超単純な波形クリップ
        waveShaper.oversample = "4x";

        bufferSource.connect(gainNode);
        gainNode.connect(waveShaper);
        waveShaper.connect(audioCtx.destination);

        bufferSource.start();
        sourceNode = bufferSource;
        log("再生開始（音割れ効果あり）");
      } catch (e) {
        log("エラー: " + e.message);
      }
    }
  </script>
</body>
</html>
